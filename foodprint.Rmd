---
title: "Food waste transport & treatment emissions"
output: flexdashboard::flex_dashboard
---


```{r setup, include=FALSE}
#attempting a flexdashboard home button this way breaks knitr/distil rendering
#    navbar:
#      - { title: "Passerium", href: "https://passerium.netlify.app/" }
library(flexdashboard)
library(shiny)
library(DiagrammeR)
library(projects)
library(here)
library(tidyverse)
library(ggplot2)
library(igraph)
library(readxl)
library(openxlsx)
library(rgdal)
library(kableExtra)
library(sf)
library(ggrepel)
library(leaflet)
```



```{r, include=FALSE}
#copying from 03_analysis
#weight
mass_dist<-read_xlsx(here("data","SolidWasteAssumptions.xlsx"), sheet="BEAM_general",col_names=TRUE,range="J150:R166")
mass_dist.Ex_0<-mass_dist %>% 
  mutate(weight=Ex_00_AnnualOrganicTonnage/sum(Ex_00_AnnualOrganicTonnage))
mass_dist.EOMFWG<-mass_dist %>% 
  mutate(weight=EOMFWG_10_AnnualOrganicTonnage/sum(EOMFWG_10_AnnualOrganicTonnage))
mass_dist.ADFWG<-mass_dist %>% 
  mutate(weight=ADFWG_10_AnnualOrganicTonnage/sum(ADFWG_10_AnnualOrganicTonnage))

#mass_dist[1:14,c(4,6,7)]%>%  #exclude other scenarios and hypo ADcolumn
#  kable(col.names=c('Facility', 'Type', 'Annual organic waste (wet tonnage)'), digits = 0) %>%  
#  column_spec(1, width = "30em") %>% # force first one wider to fit text
#kable_styling()


# edges: create connections between ; add 15 when new AD defined
links <- data.frame(source=c(1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2), target=c(3,4,5,6,7,8,9,10,11,12,13,14,3,4,5,6,7,8,9,10,11,12,13,14), weight=c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),category=c(1,1,2,2,3,3,3,3,1,1,1,1,2,2,2,2,3,3,3,3,3,3,3,3))

links$category<-c(mass_dist$category[3:14],mass_dist$category[3:14])
links <- links %>% mutate(category = as.factor(category))

#this assumes Earl Turcott and YRWMC has 75/25 split based on ref.
WasteFractionTo_ETWMC<-0.75
WasteFractionTo_YRWMC<-0.25

links$weight.Ex_0<-links$weight*c(mass_dist.Ex_0$weight[3:14]*WasteFractionTo_ETWMC,mass_dist.Ex_0$weight[3:14]*WasteFractionTo_YRWMC)
links$tonnage.Ex_0<-links$weight.Ex_0*sum(mass_dist.Ex_0$Ex_00_AnnualOrganicTonnage)
#check 1-4 correct

links$weight.EOMFWG_10<-links$weight*c(mass_dist.EOMFWG$weight[3:14]*WasteFractionTo_ETWMC,mass_dist.EOMFWG$weight[3:14]*WasteFractionTo_YRWMC)
links$tonnage.EOMFWG_10<-links$weight.EOMFWG_10*sum(mass_dist.EOMFWG$EOMFWG_10_AnnualOrganicTonnage)

links$weight.ADFWG_10<-links$weight*c(mass_dist.ADFWG$weight[3:14]*WasteFractionTo_ETWMC,mass_dist.ADFWG$weight[3:14]*WasteFractionTo_YRWMC)
links$tonnage.ADFWG_10<-links$weight.ADFWG_10*sum(mass_dist.ADFWG$ADFWG_10_AnnualOrganicTonnage)
```



Column {.tabset}
----------------------------------
  
### Bean Counting >>
Hypothetical tonnages generated by seeded randomizer.  GHG emission rates will be sourced from EPA's WARM v. 15 for food waste in *short tons* (to correct to metric). 

#### Tonnages by Location

```{r}
#https://community.rstudio.com/t/multiple-plots-on-a-storyboard-page/33986
#EPA WARM:
dt_TreatmentGHGRef<-data.frame(category=c("AD-leachate","AD-SSO","Incineration","Compost","Landfill"),CO2ETperTonne=c(-0.02,-0.04,-0.13,-0.12,0.5))
# category to match for join
dt_TreatmentGHG<- dt_TreatmentGHGRef %>% 
  right_join(links,by="category") %>%  
  group_by(target) %>% 
  mutate(category = paste(category),CO2ETperTonne = paste(CO2ETperTonne)) %>%  #extra mutate and group by otherwise the two columns are lost/added
  group_by(target,category, CO2ETperTonne) %>%  #https://stackoverflow.com/questions/46553514/applying-group-by-and-summarisesum-but-keep-columns-with-non-relevant-conflict
  summarise_if(is.numeric, sum) 
#note Residuals not deducted for org %
dt_TreatmentGHG<-right_join(dt_TreatmentGHGRef,dplyr::select(dt_TreatmentGHG, -CO2ETperTonne))

#fake tonnages 
set.seed(2)
dt_TreatmentGHG$RandomOrganicTonnage<-sample(12)*1000
dt_TreatmentGHG$CO2ETperTonne<-as.numeric(dt_TreatmentGHG$CO2ETperTonne)
dt_TreatmentGHG$TreatmentCO2ET<-dt_TreatmentGHG$RandomOrganicTonnage*dt_TreatmentGHG$CO2ETperTonne

dt_TreatmentGHG [c(1,2,3,7)]%>% kable(col.names=c('TreatmentTYpe', 'Emission (CO2equiv/t Food Waste)', 'Facility ID', 'Food Waste (t/year)')) %>% kable_styling
```

### Massive Un-mangling >>
#### Mind-mapping/Flowcharting the paths using DiagrammeR

##### Source separated food waste paths

```{r,eval=TRUE,echo=FALSE}
# https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/
library('DiagrammeR')
#try sub-clusters later - https://github.com/dr-harper/blog/blob/master/content/post/2018-05-01-flowcharts-in-r-using-diagrammer/planningGrouping.gv

DiagrammeR::grViz("digraph {

                  graph [layout = dot]
                  # define the global styles of the nodes. We can override these in box if we wish
                  node [shape = rectangle, style = filled, fillcolor = Linen]
                  
                  start1 [label = 'A Collection']
                  start2 [label = 'B Collection']
                  TS1 [label = 'Y Transfer Station']
                  TS2 [label = 'Z Transfer Station']
                  Dest9 [label =  'Treatment/Disposal Site 9', fillcolor=pink]
                  Dest10 [label =  'Treatment/Disposal Site 10',fillcolor=green]
                  Dest11 [label =  'Treatment/Disposal Site 11', fillcolor=green]
                  Dest12 [label =  'Treatment/Disposal Site 12', fillcolor=green]
                  Dest13 [label =  'Treatment/Disposal Site 13', fillcolor=gold]
                  Dest14 [label =  'Treatment/Disposal Site 14', fillcolor=gold]

                  # edge definitions with the node IDs
                  start1-> TS1  
                  start2 -> TS2
                  TS1 -> {Dest9 Dest10 Dest11 Dest12 Dest13 Dest14}
                  TS2 -> {Dest9 Dest10 Dest11 Dest12 Dest13 Dest14}
                
                  }")
```

##### Mixed garbage paths 
```{r,eval=TRUE,echo=FALSE}
DiagrammeR::grViz("digraph {

                  graph [layout = dot]
                  # define the global styles of the nodes. We can override these in box if we wish
                  node [shape = rectangle, style = filled, fillcolor = Linen]
                  
                  start0 [label = 'A Collection ']
                  start1 [label = 'B Collection']
                  start2 [label = 'C Collection']
                  TS1 [label = 'Y Transfer Station']
                  TS2 [label = 'Z Transfer Station']
                  Dest3 [label =  'Treatment/Disposal Site 3', fillcolor=gray]
                  Dest4 [label =  'Treatment/Disposal Site 4',fillcolor=red]
                  Dest5 [label =  'Treatment/Disposal Site 5', fillcolor=red]
                  Dest6 [label =  'Treatment/Disposal Site 6', fillcolor=lightblue]
                  Dest7 [label =  'Treatment/Disposal Site 7', fillcolor=lightblue]
                  Dest8 [label =  'Treatment/Disposal Site 8', fillcolor=lightblue]

                  # edge definitions with the node IDs
                  start0 -> Dest6
                  start1-> TS1  
                  start2 -> TS2
                  TS1 -> {Dest3 Dest4 Dest5 Dest6 Dest7 Dest8}
                  TS2 -> {Dest3 Dest4 Dest5 Dest6 Dest7 Dest8}
                
                  }")
```


### Lay of the Land  >>

Where are the facilities relative to the transfer stations?  Will some transportation emissions associated with these facilities be disproportionate due to haulage distance?  
```{r, echo=FALSE}
library(sf)
library(ggmap)
library(rgdal)

locs<- st_read(here("data","YR-FoodWasteADaltered.kml"))

locs$StartNode<- as.numeric(grepl("WM", locs$Name)) #Earl Turcott and York Region
locs$EndNode<- ifelse(locs$StartNode!=1,1,0)
locs$index<-as.numeric(rownames(locs))

locs_lat_lon<- st_transform(locs,crs = 3857)
locs_lat_lon <- cbind(locs, st_coordinates(locs)) #gives option to use x y for geom_point

locs.f<-locs_lat_lon %>% filter(index>2) %>% 
  rename("target"="index")

dt_TreatmentGHG.f<-merge(dt_TreatmentGHG, locs.f, by="target")

#ggplot(dt_TreatmentGHG.f,aes(X,Y))+
#  geom_point()
```


```{r,echo=FALSE}
xmin<-as.numeric(st_bbox(locs)[1]) #xmin
ymin<-as.numeric(st_bbox(locs)[2]) #ymin
xmax<-as.numeric(st_bbox(locs)[3]) #xmax
ymax<-as.numeric(st_bbox(locs)[4]) #ymax

bbox_yr<-c(left = xmin-3, bottom = ymin-3, right = xmax+3, top = ymax+3)
ggmap_yr <- ggmap(get_stamenmap(bbox_yr, zoom =7, maptype = "terrain-lines"))  #options are at https://www.r-graph-gallery.com/324-map-background-with-the-ggmap-library.html
```

#### Mapping it out >>
```{r}
#if geometry is not split, leaflet can't infer long lat
dt_TreatmentGHG.f$lng = as.numeric(st_coordinates(dt_TreatmentGHG.f$geometry)[,1])
dt_TreatmentGHG.f$lat = as.numeric(st_coordinates(dt_TreatmentGHG.f$geometry)[,2])

# Create a palette that maps factor levels to colors
pal <- colorFactor(c("red","gold","green","blue","purple"), c("AD-leachate","AD-SSO","Incineration","Compost","Landfill"))

LeafletMap<-leaflet(dt_TreatmentGHG.f) %>% addTiles() %>% addCircleMarkers(color = ~pal(category), radius = ~tonnage.Ex_0/max(dt_TreatmentGHG.f$tonnage.Ex_0)*39, label=paste("Facility ",dt_TreatmentGHG.f$target), labelOptions = labelOptions(noHide = T)) %>% addLegend("bottomleft", pal = pal, values=~category)


library(widgetframe) #https://stackoverflow.com/questions/63495178/leaflet-not-rendering-in-dynamically-generated-r-markdown-html-knitr
widgetframe::frameWidget(LeafletMap, width = "100%")

```

#### preparing for next stage 
```{r, echo=TRUE}
#create edge & node join for plot based on r-bloggers 2018 method #https://www.r-bloggers.com/2018/05/three-ways-of-visualizing-a-graph-on-a-map/

#making connectors
locs_lat_lon<-dplyr::select(locs_lat_lon, index, X,Y, Name)

edges_for_plot <- links %>%
  inner_join(locs_lat_lon %>% dplyr::select(index, X, Y), by = c('source' = 'index')) %>%
  rename(x = X, y = Y) %>%
  inner_join(locs_lat_lon %>% dplyr::select(index, X,Y), by = c('target' = 'index')) %>%
  rename(xend = X, yend = Y)
```

 
Showing where the facilities are and trying to demarcate type of process undertaken there, as well as sizing markers by annual tonnages received.  
Then, create edges & nodes join to ready for connectors.


### Catapaulting >>
Food waste-hurling fun - Creating weighted arrows showing flows from transfer stations (1,2) to the facilities (3 through 14)
  
```{r}
map.Ex_0<-
ggmap_yr+
  geom_point(data=locs_lat_lon,aes(x=X, y=Y),colour = "red", size = 3,  alpha = 0.5)+ #loc lat long is pure geometry
  coord_sf(xlim = c(xmin-1, xmax+1), ylim = c(ymin-0.5,ymax+0.5)) +
  geom_curve(aes(x = x, y = y, xend = xend, yend = yend, # draw edges as arcs
      color = category, size = tonnage.Ex_0),
      data = edges_for_plot, curvature = 0.33, #tonnages table
      alpha = 0.5)+
#  scale_size_continuous(guide = FALSE, range = c(1, 6)) +    # scale node size
  geom_text_repel(data=locs_lat_lon,aes(x=X, y =Y, label=c('Station 1','Station 2','Facility 3','Facility 4','Facility 5','Facility 6','Facility 7','Facility 8','Facility 9','Facility 10','Facility 11','Facility 12','Facility 13','Facility 14')),# labels
          #hjust = 0, nudge_x = 1, nudge_y = 4,
          size = 2, color = "black", fontface = "bold")  

map.Ex_0
```


### !The Judgement
TBD - mini bar charts at each location showing treatment emissions vs. transport

```{r, echo=FALSE}
#https://stackoverflow.com/questions/20465070/barplots-on-a-map
# set the x and y of geom_errorbar() is longitude and latitude; and the ymin and ymax is stat of your data .
#...failed
ggplot() +
  ggmap_yr+
  geom_point(data=locs_lat_lon,aes(x=X, y=Y),colour = "red", size = 3,  alpha = 0.5)+ #loc lat long is pure geometry
  coord_sf(xlim = c(xmin-1, xmax+1), ylim = c(ymin-0.5,ymax+0.5)) +
  ggtitle("test subplot") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  geom_errorbar(data = dt_TreatmentGHG.f[c(13, 22,23), ], 
                aes(x = lng,ymin=lat-1,ymax=lat+3,#(TreatmentCO2ET/1000)), 
                color='blue', size = 3, width=0))

#https://stackoverflow.com/questions/36063043/how-to-plot-barchart-onto-ggplot2-map
```

***